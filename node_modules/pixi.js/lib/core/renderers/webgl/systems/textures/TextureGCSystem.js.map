{"version":3,"sources":["../../../../../../src/core/renderers/webgl/systems/textures/TextureGCSystem.js"],"names":["TextureGCSystem","renderer","count","checkCount","maxIdle","GC_MAX_IDLE","checkCountMax","GC_MAX_CHECK_COUNT","mode","GC_MODE","postrender","MANUAL","run","tm","texture","managedTextures","wasRemoved","i","length","frameBuffer","touched","destroyTexture","j","unload","displayObject","textureSystem","_texture","_glRenderTargets","children"],"mappings":";;;;AAAA;;;;AACA;;AACA;;;;;;;;;;;;AAEA;;;;;;;IAOqBA,e;;;AAEjB;;;AAGA,6BAAYC,QAAZ,EACA;AAAA;;AAAA,qDACI,wBAAMA,QAAN,CADJ;;AAGI,cAAKC,KAAL,GAAa,CAAb;AACA,cAAKC,UAAL,GAAkB,CAAlB;AACA,cAAKC,OAAL,GAAe,mBAASC,WAAxB;AACA,cAAKC,aAAL,GAAqB,mBAASC,kBAA9B;AACA,cAAKC,IAAL,GAAY,mBAASC,OAArB;AAPJ;AAQC;;AAED;;;;;;8BAIAC,U,yBACA;AACI,aAAKR,KAAL;;AAEA,YAAI,KAAKM,IAAL,KAAc,gBAASG,MAA3B,EACA;AACI;AACH;;AAED,aAAKR,UAAL;;AAEA,YAAI,KAAKA,UAAL,GAAkB,KAAKG,aAA3B,EACA;AACI,iBAAKH,UAAL,GAAkB,CAAlB;;AAEA,iBAAKS,GAAL;AACH;AACJ,K;;AAED;;;;;;8BAIAA,G,kBACA;AACI,YAAMC,KAAK,KAAKZ,QAAL,CAAca,OAAzB;AACA,YAAMC,kBAAmBF,GAAGE,eAA5B;AACA,YAAIC,aAAa,KAAjB;;AAEA,aAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIF,gBAAgBG,MAApC,EAA4CD,GAA5C,EACA;AACI,gBAAMH,UAAUC,gBAAgBE,CAAhB,CAAhB;;AAEA;AACA,gBAAI,CAACH,QAAQK,WAAT,IAAwB,KAAKjB,KAAL,GAAaY,QAAQM,OAArB,GAA+B,KAAKhB,OAAhE,EACA;AACIS,mBAAGQ,cAAH,CAAkBP,OAAlB,EAA2B,IAA3B;AACAC,gCAAgBE,CAAhB,IAAqB,IAArB;AACAD,6BAAa,IAAb;AACH;AACJ;;AAED,YAAIA,UAAJ,EACA;AACI,gBAAIM,IAAI,CAAR;;AAEA,iBAAK,IAAIL,KAAI,CAAb,EAAgBA,KAAIF,gBAAgBG,MAApC,EAA4CD,IAA5C,EACA;AACI,oBAAIF,gBAAgBE,EAAhB,MAAuB,IAA3B,EACA;AACIF,oCAAgBO,GAAhB,IAAuBP,gBAAgBE,EAAhB,CAAvB;AACH;AACJ;;AAEDF,4BAAgBG,MAAhB,GAAyBI,CAAzB;AACH;AACJ,K;;AAED;;;;;;;8BAKAC,M,mBAAOC,a,EACP;AACI,YAAMX,KAAK,KAAKZ,QAAL,CAAcwB,aAAzB;;AAEA;AACA,YAAID,cAAcE,QAAd,IAA0BF,cAAcE,QAAd,CAAuBC,gBAArD,EACA;AACId,eAAGQ,cAAH,CAAkBG,cAAcE,QAAhC,EAA0C,IAA1C;AACH;;AAED,aAAK,IAAIT,IAAIO,cAAcI,QAAd,CAAuBV,MAAvB,GAAgC,CAA7C,EAAgDD,KAAK,CAArD,EAAwDA,GAAxD,EACA;AACI,iBAAKM,MAAL,CAAYC,cAAcI,QAAd,CAAuBX,CAAvB,CAAZ;AACH;AACJ,K;;;;;kBAjGgBjB,e","file":"TextureGCSystem.js","sourcesContent":["import WebGLSystem from '../WebGLSystem';\nimport { GC_MODES } from '../../../../const';\nimport settings from '../../../../settings';\n\n/**\n * TextureGarbageCollector. This class manages the GPU and ensures that it does not get clogged\n * up with textures that are no longer being used.\n *\n * @class\n * @memberof PIXI\n */\nexport default class TextureGCSystem extends WebGLSystem\n{\n    /**\n     * @param {PIXI.WebGLRenderer} renderer - The renderer this System works for.\n     */\n    constructor(renderer)\n    {\n        super(renderer);\n\n        this.count = 0;\n        this.checkCount = 0;\n        this.maxIdle = settings.GC_MAX_IDLE;\n        this.checkCountMax = settings.GC_MAX_CHECK_COUNT;\n        this.mode = settings.GC_MODE;\n    }\n\n    /**\n     * Checks to see when the last time a texture was used\n     * if the texture has not been used for a specified amount of time it will be removed from the GPU\n     */\n    postrender()\n    {\n        this.count++;\n\n        if (this.mode === GC_MODES.MANUAL)\n        {\n            return;\n        }\n\n        this.checkCount++;\n\n        if (this.checkCount > this.checkCountMax)\n        {\n            this.checkCount = 0;\n\n            this.run();\n        }\n    }\n\n    /**\n     * Checks to see when the last time a texture was used\n     * if the texture has not been used for a specified amount of time it will be removed from the GPU\n     */\n    run()\n    {\n        const tm = this.renderer.texture;\n        const managedTextures =  tm.managedTextures;\n        let wasRemoved = false;\n\n        for (let i = 0; i < managedTextures.length; i++)\n        {\n            const texture = managedTextures[i];\n\n            // only supports non generated textures at the moment!\n            if (!texture.frameBuffer && this.count - texture.touched > this.maxIdle)\n            {\n                tm.destroyTexture(texture, true);\n                managedTextures[i] = null;\n                wasRemoved = true;\n            }\n        }\n\n        if (wasRemoved)\n        {\n            let j = 0;\n\n            for (let i = 0; i < managedTextures.length; i++)\n            {\n                if (managedTextures[i] !== null)\n                {\n                    managedTextures[j++] = managedTextures[i];\n                }\n            }\n\n            managedTextures.length = j;\n        }\n    }\n\n    /**\n     * Removes all the textures within the specified displayObject and its children from the GPU\n     *\n     * @param {PIXI.DisplayObject} displayObject - the displayObject to remove the textures from.\n     */\n    unload(displayObject)\n    {\n        const tm = this.renderer.textureSystem;\n\n        // only destroy non generated textures\n        if (displayObject._texture && displayObject._texture._glRenderTargets)\n        {\n            tm.destroyTexture(displayObject._texture, true);\n        }\n\n        for (let i = displayObject.children.length - 1; i >= 0; i--)\n        {\n            this.unload(displayObject.children[i]);\n        }\n    }\n}\n"]}